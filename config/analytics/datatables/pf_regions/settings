nameSingle: region
namePlural: regions

icon: fa-globe

primKey: region_id
isPositionOnGenome: false


quickFindFields: region_id, name, description

sortDefault: name

listView: true

itemTitle: "{{name}}"

properties:
- id: region_id
  dataType: Text
- id: lat
  dataType: Double
- id: lng
  dataType: Double
- id: num_samples
  dataType: Double
- id: description
  dataType: Text
- id: name
  name: Region
  dataType: Text
- id: geojson
  dataType: GeoJSON
  isCategorical: False
- id: web_colour
  dataType: Text

- id: CQresistance, SDXresistance, PYRresistance, MQresistance, ARTresistance, PPQresistance
  dataType: Float
  isCategorical: False
  scaleColours:
    thresholds: [0, 5, 20, 40, 60, 80, 100]
    colours: ["green", "rgb(247, 230, 0)", "...", "...", "...", "rgb(212, 41, 41)"]
    nullColour: "#F2EFE9"
    interpolate: False

- id: CQresistance
  name: "% Chloroquine Resistance"
- id: PYRresistance
  name: "% Pyrimethamine Resistance"
- id: SDXresistance
  name: "% Sulfadoxine Resistance"
- id: MQresistance
  name: "% Mefloquine Resistance"
- id: ARTresistance
  name: "% Artemisinin Resistance"
- id: PPQresistance
  name: "% Piperaquine Resistance"


dataItemViews:              # Lists the custom views that should appear in the popup for an individual data table item
- type: Template                                       # Add a template based view
  name: Details
  content: |
    <PageTemplate bgurl="mountains.jpg">
        <BreadCrumb a="pf" b="regions"><span>{{name}}</span></BreadCrumb>
        <CardStack>
            <Card>
                <CardContent>
                    <Typography type="headline">
                        Sample sites in {{name}}
                    </Typography>
                    <Typography type="subheading" color="secondary">

                    </Typography>
                    <Typography component="div">
                      Analysis based on <strong><QueryResult table="pf_samples" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' /></strong> <em>P.falciparum</em> samples
                      collected <TextRange table="pf_samples" property="year" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' from <QueryResult table="pf_samples" singular="study site" plural="study sites" expression='["count", [["distinct", ["site_id"]]]]' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' /> in <QueryResult table="pf_samples" singular="country" plural="countries" expression='["count", [["distinct", ["country_id"]]]]' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' /> in <strong>{{name}}</strong>
                       </Typography>
                        <div class="auto-half-height-container">
                           <div class="auto-height-inner">
                            <Map>
                                <TileLayer />
                                <TableGeoJSONsLayer
                                  showLegend="false"
                                  table="pf_regions"
                                  geoJsonProperty="geojson"
                                  labelProperty="name"
                                  query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}'
                                  colour="{{constant 'mapPolygon'}}"
                                />
                                <TableMarkersLayer
                                  clusterMarkers="false"
                                  showLegend="false"
                                  clickTable="sites"
                                  clickPrimaryKeyProperty="site_id"
                                  table="pf_samples"
                                  markerColourProperty="country_id"
                                  query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}'
                                  joins='[
                                    {"type": "INNER", "foreignTable": "pf_regions", "foreignColumn": "region_id", "column": "region_id"}
                                  ]'
                                  onClickSingleBehaviour="tooltip"
                                  onClickSingleComponent="ItemTemplate"
                                  onClickSingleComponentTemplateDocPath="templates/ResistanceMapOnClickSingleTooltip.html"
                                />
                            </Map>
                           </div>
                        </div>
                </CardContent>
            </Card>
            <Card>
                <CardContent>
                  <Typography type="headline">
                   Drug resistance predictions
                  </Typography>
                  <DocTemplate path="templates/proportionPlotTitle.html"/>
                    <Typography component="div">
                        <div style="padding-top: 20px">
                          <ProportionBarChartWrap
                            numberOfTickLabels="5"
                          >
                            {{#query 'drug_id' 'name' table='pf_drugs'}}
                              <ProportionBarChartRow
                                rowTable="pf_drugs"
                                rowPrimKeyValue="{{drug_id}}"
                                rowLabel="{{name}}"
                                proportionTable="pf_samples"
                                numeratorBarColour="{{constant 'numeratorBar'}}"
                                numeratorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{../region_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{drug_id}}resistant","CompValue":"resistant","Tpe":"="}],"Tpe":"AND"}'
                                denominatorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{../region_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{drug_id}}resistant","CompValue":"missing","Tpe":"<>"}],"Tpe":"AND"}'
                                remainderTextColour="inherit"
                                onClickBehaviour="ItemLink"
                                onClickTable="pf_drug_regions"
                                onClickPrimKey="{}_{{../region_id}}"
                                colourProperty="pf_regions.{{drug_id}}resistance"
                              />
                            {{/query}}
                          </ProportionBarChartWrap>
                        </div>
                      </Typography>
                      <DocTemplate path="templates/proportionPlotLegend.html"/>
                </CardContent>
            </Card>
            <Card >
                <CardContent>
                    <Typography type="headline">
                        How we predict resistance
                    </Typography>
                    <List>
                      <ObsListItem download href="downloads/Markers_to_phenotype_mapping_-_SOP_v1_2.pdf" target="_blank">
                        <ListItemIcon><Icon class="icon" name='docimage:icons/publications-reports.svg' />
                        </ListItemIcon>
                          <ListItemText>
                          <span>Our standard operating procedure for inferring antimalarial resistance from DNA</span>
                        </ListItemText>
                      </ObsListItem>
                    </List>
                </CardContent>
            </Card>

        </CardStack>
    </PageTemplate>
