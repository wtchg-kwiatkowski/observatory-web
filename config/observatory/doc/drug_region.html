{{#query 'drug_id' 'name' table='pf_drugs' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"drug_id","CompValue":"{{drug_id}}","isRoot":true,"Tpe":"="}'}}
{{#query 'region_id' 'name' 'web_colour' table='pf_regions' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{@root/region_id}}","isRoot":true,"Tpe":"="}'}}
<PageTemplate bgurl="mountains.jpg">
    <BreadCrumb a="pf" b="regions"><ItemLink table="pf_regions" primKey="{{region_id}}"><span class="obs-breadcrumb-component"><i style="padding-right:3px;color:{{web_colour}}" class="fa fa-square" aria-hidden="true"></i><a>{{name}}</a></span></ItemLink><span>{{../name}} in {{name}}</span></BreadCrumb>
  <CardStack>
    <Card>
      <CardContent>
        <Typography type="headline">
          {{../name}} resistance in {{name}}
        </Typography>
        <Typography type="subheading" color="secondary">
          Summary
        </Typography>

        <Typography component="div" className="paragraph">
          We predict
          <strong><PercentMatching
            numQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{../drug_id}}resistant","CompValue":"resistant","Tpe":"="}],"Tpe":"AND"}'  domQuery='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' table='pf_samples'/></strong> {{lowercase ../name}} resistance in {{name}} based on <strong><QueryResult table="pf_samples" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' /></strong> samples
          </Typography>

          <Typography type="subheading" color="secondary">
            Current situation
          </Typography>

          <Typography component="div" className="paragraph">
          {{#query
            'pf_regions.name'
            'pf_drugs.name'
            'text'
            table='pf_drug_regions'
            query='{"whcClass":"comparefixed","isCompound":false,"ColName":"drug_region_id","CompValue":"{{@root/drug_id}}_{{region_id}}","isRoot":true,"Tpe":"="}'
            joins='[
              {"type": "INNER", "foreignTable": "pf_regions", "foreignColumn": "pf_regions.region_id", "column": "pf_drug_regions.region_id"},
              {"type": "INNER", "foreignTable": "pf_drugs", "foreignColumn": "pf_drugs.drug_id", "column": "pf_drug_regions.drug_id"}
            ]'
          }}
            <div>{{{eval text}}}</div>
          {{/query}}
        </Typography>
       
        <PopupButton target="dataItemPopup" table="pf_drugs" primKey="{{../drug_id}}">
          <Label>
            <Icon
              baseURL="/panoptes/Docs/observatory/images/icons/"
              name="image:drug01.svg"
              style="margin-right: 0.5em;"
            />
            {{../name}}
          </Label>
        </PopupButton>
      </CardContent>
    </Card>
    <Card>
      <CardContent>
        <Typography component="div">
          <div class="auto-half-height-container">
            <div class="auto-height-inner">
              <Map disableInteraction>
                <TileLayer />
                <TableGeoJSONsLayer showLegend="false" table="pf_regions" geoJsonProperty="geojson" colourProperty="web_colour" labelProperty="name" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' />
                <TableMarkersLayer
                  showLegend="false"
                  query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}'
                  table="pf_samples"
                  clusterMarkers="true"
                  markerColourProperty="{{../drug_id}}resistant"
                  onClickClusterBehaviour="tooltip"
                  onClickClusterComponent="HandlebarsWithComponents"
                  onClickClusterComponentProps='{"drug_id":"{{../drug_id}}","drug_name":"{{../name}}"}'
                  onClickClusterComponentTemplateDocPath="templates/drugResistanceInRegionSiteSamplesOnClickClusterTooltip.html"
                />
            </div>
          </div>
        </Typography>
      </CardContent>
    </Card>
    <Card>
      <CardContent>
          <Typography type="headline">
              Proportion of {{lowercase ../name}} resistant parasites across sites in {{name}}
          </Typography>
          <Typography type="subheading" color="secondary">

          </Typography>
          <Typography component="div">
              The count of parasites from a site shown on the right is a subset of all parasites from that site and includes only those where we're able to make a clear prediction of resistance (ie <em>yes</em> or <em>no</em> in the map above). This number therefore does not include those parasites where we're unsure of resistance status (ie the group labelled <em>maybe</em>).

              <div style="padding-top: 20px">
                <ProportionBarChartWrap
                  numberOfTickLabels="5"
                >
                {{#query
                  'countries.country_id'
                  'alpha_3_code'
                  'countries.name'
                  'num_samples'
                  table='countries'
                  joins='[{"type": "INNER", "foreignTable": "sites", "foreignColumn": "sites.country_id", "column": "countries.country_id"}]'
                  query='{"whcClass":"comparefixed","isCompound":false,"ColName":"sites.pf_region_id","CompValue":"{{region_id}}","Tpe":"="}'
                  distinct='true'
                  orderBy='[["asc","countries.name"]]'
                }}
                  <tr><th style="text-align: left;">{{{countries.name}}} ({{alpha_3_code}})</th></tr>
                  {{#query
                    'site_id'
                    'sites.name'
                    table='sites'
                    query='{"whcClass":"comparefixed","isCompound":false,"ColName":"country_id","CompValue":"{{countries.country_id}}","Tpe":"="}'
                  }}
                    <ProportionBarChartRow
                      key="ProportionBarChartRow_{{site_id}}"
                      rowTable="sites"
                      rowPrimKeyValue="{{site_id}}"
                      rowLabel="{{sites.name}}"
                      rowLabelStyle='{"paddingLeft": "8px"}'
                      proportionTable="pf_samples"
                      proportionTableColourColumn="{{@root/drug_id}}resistant"
                      proportionTableColourColumnNumeratorValue="resistant"
                      numeratorBarColour="#69B3E4"
                      numeratorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"country_id","CompValue":"{{../countries.country_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{site_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{@root/drug_id}}resistant","CompValue":"resistant","Tpe":"="}],"Tpe":"AND"}'
                      denominatorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"country_id","CompValue":"{{../countries.country_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{site_id}}","Tpe":"="},{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"{{@root/drug_id}}resistant","CompValue":"resistant","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{@root/drug_id}}resistant","CompValue":"sensitive","Tpe":"="}],"Tpe":"OR"}],"Tpe":"AND"}'
                      remainderTextColour="inherit"
                    />
                  {{/query}}
                {{/query}}
                </ProportionBarChartWrap>
              </div>

          </Typography>
          <DocTemplate path="templates/warningCardContent.html"/>
      </CardContent>
    </Card>

  </CardStack>
</PageTemplate>
{{/query}}
{{/query}}
