{{#query 'drug_id' 'name' table='pf_drugs' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"drug_id","CompValue":"{{drug_id}}","isRoot":true,"Tpe":"="}'}}
{{#query 'region_id' 'name' 'web_colour' table='pf_regions' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{@root/region_id}}","isRoot":true,"Tpe":"="}'}}
<PageTemplate bgurl="mountains.jpg">
    <BreadCrumb a="pf" b="regions"><ItemLink table="pf_regions" primKey="{{region_id}}"><span class="obs-breadcrumb-component"><i style="padding-right:3px;color:{{web_colour}}" class="fa fa-square" aria-hidden="true"></i><a>{{name}}</a></span></ItemLink><span>{{../name}} in {{name}}</span></BreadCrumb>
  <CardStack>
    <Card>
      <CardContent>
        <Typography type="headline">
          {{../name}} in {{name}}
        </Typography>
        <Typography type="subheading" color="secondary">

        </Typography>
        <Typography omponent="div">
          {{#query 'text' table='pf_drug_regions' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"drug_region_id","CompValue":"{{@root/drug_id}}_{{region_id}}","isRoot":true,"Tpe":"="}'}}
            {{{text}}}
          {{/query}}
        </Typography>
      </CardContent>
    </Card>
    <Card>
      <CardContent>
        <Typography component="div">The Malaria Observatory has <strong><QueryResult table="pf_samples" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' /></strong>
          <em>P.falciparum</em> samples from <strong><QueryResult table="pf_samples" expression='["count", [["distinct", ["site_id"]]]]' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' /></strong> study sites classed as
          <strong>{{name}}</strong> of which <strong><QueryResult table="pf_samples" query='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{../drug_id}}resistant","CompValue":"yes","Tpe":"="}],"Tpe":"AND"}' /></strong> have markers for {{../name}} resistance.
          <div class="auto-half-height-container">
            <div class="auto-height-inner">
              <Map disableInteraction>
                <TileLayer />
                <TableGeoJSONsLayer showLegend="false" table="pf_regions" geoJsonProperty="geojson" colourProperty="web_colour" labelProperty="name" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' />
                <TableMarkersLayer
                  showLegend="false"
                  query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}'
                  table="pf_samples"
                  clusterMarkers="true"
                  markerColourProperty="{{../drug_id}}resistant"
                  onClickClusterBehaviour="tooltip"
                  onClickClusterComponent="HandlebarsWithComponents"
                  onClickClusterComponentProps='{"drug_id":"{{../drug_id}}","drug_name":"{{../name}}"}'
                  onClickClusterComponentTemplateDocPath="templates/drugResistanceInRegionSiteSamplesOnClickClusterTooltip.html"
                />
            </div>
          </div>
        </Typography>
      </CardContent>
    </Card>
    <Card>
      <CardContent>
          <Typography type="headline">
              Frequency of {{lowercase ../name}} resistance
          </Typography>
          <Typography type="subheading" color="secondary">

          </Typography>
          <Typography component="div">
              The proportion of <em>P. falciparum</em> samples with markers of <strong>{{lowercase ../name}}</strong> resistance are:

              <div style="padding-top: 20px">
                <ProportionBarChartWrap>
                {{#query
                  'countries.country_id'
                  'alpha_3_code'
                  'countries.name'
                  'num_samples'
                  table='countries'
                  joins='[{"type": "INNER", "foreignTable": "sites", "foreignColumn": "sites.country_id", "column": "countries.country_id"}]'
                  query='{"whcClass":"comparefixed","isCompound":false,"ColName":"sites.pf_region_id","CompValue":"{{region_id}}","Tpe":"="}'
                  distinct='true'
                  orderBy='[["asc","countries.name"]]'
                }}
                  <tr><td>{{{countries.name}}} ({{alpha_3_code}})</td></tr>
                  {{#query
                    'site_id'
                    'sites.name'
                    table='sites'
                    query='{"whcClass":"comparefixed","isCompound":false,"ColName":"country_id","CompValue":"{{countries.country_id}}","Tpe":"="}'
                  }}
                    <ProportionBarChartRow
                      key="ProportionBarChartRow_{{site_id}}"
                      rowTable="sites"
                      rowPrimKeyValue="{{site_id}}"
                      rowLabel="{{sites.name}}"
                      proportionTable="pf_samples"
                      proportionTableColourColumn="{{@root/drug_id}}resistant"
                      proportionTableColourColumnNumeratorValue="yes"
                      numeratorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"country_id","CompValue":"{{../countries.country_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{site_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{@root/drug_id}}resistant","CompValue":"yes","Tpe":"="}],"Tpe":"AND"}'
                      denominatorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"country_id","CompValue":"{{../countries.country_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{site_id}}","Tpe":"="},{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"{{@root/drug_id}}resistant","CompValue":"yes","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{@root/drug_id}}resistant","CompValue":"no","Tpe":"="}],"Tpe":"OR"}],"Tpe":"AND"}'
                      remainderTextColour="inherit"
                      numberOfTickLabels="5"
                    />
                  {{/query}}
                {{/query}}
                </ProportionBarChartWrap>
              </div>

          </Typography>
      </CardContent>
    </Card>

  </CardStack>
</PageTemplate>
{{/query}}
{{/query}}
