nameSingle: region
namePlural: regions

icon: fa-globe

primKey: region_id
isPositionOnGenome: false


quickFindFields: region_id, name, description

sortDefault: name

listView: true

itemTitle: <i style="color:{{web_colour}}" class="fa fa-square" aria-hidden="true"></i> {{name}}

properties:
- id: region_id
  dataType: Text
- id: lat
  dataType: Double
- id: lng
  dataType: Double
- id: num_samples
  dataType: Double
- id: description
  dataType: Text
- id: name
  name: Region
  dataType: Text
- id: geojson
  dataType: GeoJSON
  isCategorical: False
- id: web_colour
  dataType: Text

dataItemViews:              # Lists the custom views that should appear in the popup for an individual data table item
- type: Template                                       # Add a template based view
  name: Details
  content: |
    <PageTemplate bgurl="mountains.jpg">
        <BreadCrumb a="pf" b="regions"><span><i style="padding-right:3px;color:{{web_colour}}" class="fa fa-square" aria-hidden="true"></i> {{name}}</span></BreadCrumb>
        <CardStack>
            <Card>
                <CardContent>
                    <Typography type="headline">
                        Sample sites in {{name}}
                    </Typography>
                    <Typography type="subheading" color="secondary">

                    </Typography>
                    <Typography component="div">There are <strong><QueryResult table="pf_samples" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' /></strong>
                        <em>P.falciparum</em> samples from <QueryResult table="pf_samples" singular="study site" plural="study sites" expression='["count", [["distinct", ["site_id"]]]]' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' /> in <QueryResult table="pf_samples" singular="country" plural="countries" expression='["count", [["distinct", ["country_id"]]]]' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' /> in <strong>{{name}}</strong>

                        <div class="auto-half-height-container">
                           <div class="auto-height-inner">
                            <Map disableInteraction>
                                <TileLayer />
                                <TableGeoJSONsLayer showLegend="false" table="pf_regions" geoJsonProperty="geojson" colourProperty="web_colour" labelProperty="name" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}' />
                                <TableMarkersLayer
                                  clusterMarkers="false"
                                  showLegend="false"
                                  clickTable="sites"
                                  clickPrimaryKeyProperty="site_id"
                                  table="pf_samples"
                                  markerColourProperty="country_id"
                                  query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{region_id}}","isRoot":true,"Tpe":"="}'
                                  joins='[
                                    {"type": "INNER", "foreignTable": "pf_regions", "foreignColumn": "region_id", "column": "region_id"}
                                  ]'
                                  onClickSingleBehaviour="tooltip"
                                  onClickSingleComponent="ItemTemplate"
                                  onClickSingleComponentTemplateDocPath="templates/ResistanceMapOnClickSingleTooltip.html"
                                />
                            </Map>
                           </div>
                        </div>
                    </Typography>
                </CardContent>
            </Card>
            <Card>
                <CardContent>
                  <Typography type="headline">
                   Proportion of antimalarial drug resistant parasites in {{name}}
                  </Typography>

                  <Typography component="div" className="paragraph">
                  This plot shows the predicted number of resistant parasites for <strong><QueryResult table="pf_drugs"/></strong> major anti-malarial drugs in {{name}}.
                  </Typography>

                  <Typography component="div" className="paragraph">
                  The count of parasites shown on the right is a subset of all parasites from {{name}} and includes only those where a confident prediction of resistance can be made. This number is different across drugs because we have less confidence to predict resistance in parasites where genotyping quality is low. Genotyping data quality varies across the genomes of individual parasites.
                  </Typography>

                  <Typography component="div">
                        <div style="padding-top: 20px">
                          <ProportionBarChartWrap
                            numberOfTickLabels="5"
                          >
                            {{#query 'drug_id' 'name' table='pf_drugs'}}
                              <ProportionBarChartRow
                                rowTable="pf_drugs"
                                rowPrimKeyValue="{{drug_id}}"
                                rowLabel="{{name}}"
                                proportionTable="pf_samples"
                                proportionTableColourColumn="{{drug_id}}resistant"
                                proportionTableColourColumnNumeratorValue="yes"
                                numeratorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{../region_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{drug_id}}resistant","CompValue":"yes","Tpe":"="}],"Tpe":"AND"}'
                                denominatorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{../region_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{drug_id}}resistant","CompValue":"missing","Tpe":"<>"}],"Tpe":"AND"}'
                                remainderTextColour="inherit"
                                onClickBehaviour="DocLink"
                                docLinkHref="drug_region.html"  drug_id="{{drug_id}}" region_id="{{../region_id}}"
                              />
                            {{/query}}
                          </ProportionBarChartWrap>
                        </div>

                    </Typography>
                    <DocTemplate path="templates/warningCardContent.html"/>
                </CardContent>
            </Card>
            <Card >
                <CardContent>
                    <Typography type="headline">
                        How we predict resistance
                    </Typography>
                    <List>
                      <ObsListItem download href="downloads/Markers_to_phenotype_mapping_-_SOP_v1_1.pdf" target="_blank">
                        <ListItemIcon><Icon class="icon" baseURL='/panoptes/Docs/observatory/images/icons/' name='image:publications-reports.svg' />
                        </ListItemIcon>
                          <ListItemText>
                          <span>Our standard operating procedure for inferring antimalarial resistance from DNA</span>
                        </ListItemText>
                      </ObsListItem>
                    </List>
                </CardContent>
            </Card>
            
        </CardStack>
    </PageTemplate>
