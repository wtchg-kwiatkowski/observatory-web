nameSingle: site     # Display name referring to a table item (single, no capital)
namePlural: sites    # Display name referring to a table item (plural, no capital)
description: Information about the sites where samples were collected     # A description of this data table

icon: fa-map-marker

properties:
- id: site_id
  dataType: Text
- id: lat
  dataType: GeoLatitude
- id: lng
  dataType: GeoLongitude
- id: num_samples
  dataType: Double
- id: name
  dataType: Text
- id: pf_region_id
  name: Region
  dataType: Text
  relation:                         # This block defines a many-to-one foreign relation to a parent table
    tableId: pf_regions         # Datatable id of the parent table
    forwardName: is sampled from    # Display name of the relation from child to parent
    reverseName: contains           # Display name of the relation from parent to child
- id: country_id
  name: CountryCode
  dataType: Text
  relation:                         # This block defines a many-to-one foreign relation to a parent table
    tableId: countries         # Datatable id of the parent table
    forwardName: is in    # Display name of the relation from child to parent
    reverseName: contains           # Display name of the relation from parent to child

primKey: site_id


dataItemViews:              # Lists the custom views that should appear in the popup for an individual data table item
- type: Template                                       # Add a template based view
  name: Details
  content: |
    <PageTemplate bgurl="mountains.jpg">
        <BreadCrumb a="pf" b="regions"><ItemLink table="pf_regions" primKey="{{pf_regions.region_id}}"><span class="obs-breadcrumb-component"><i style="padding-right:3px;color:{{pf_regions.web_colour}}" class="fa fa-square" aria-hidden="true"></i><a>{{pf_regions.name}}</a></span></ItemLink><span>{{name}}</span></BreadCrumb>
        <CardStack>
            <Card>
                <CardContent>
                    <Typography type="headline">
                        {{name}}
                    </Typography>
                    <Typography type="subheading" color="secondary">
                        A site in {{countries.name}}
                    </Typography>
                    <Typography component="div">
                        There are <strong>{{num_samples}}</strong> samples from
                        <strong><QueryResult table="pf_samples"
                          singular="study" plural="studies"  expression='["count", [["distinct", ["study_id"]]]]' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{site_id}}","isRoot":true,"Tpe":"="}' /></strong> in {{name}}
                        <div class="auto-half-height-container">
                           <div class="auto-height-inner">
                            <Map disableInteraction>
                                <TileLayer />
                                    <TableGeoJSONsLayer disableClick showLegend="false" table="pf_regions" geoJsonProperty="geojson" colourProperty="web_colour" labelProperty="name" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{pf_regions.region_id}}","isRoot":true,"Tpe":"="}' />
                                    <TableMarkersLayer clusterMarkers="false" showLegend="false" clickTable="sites" clickPrimaryKeyProperty="site_id" table="pf_samples" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"region_id","CompValue":"{{pf_regions.region_id}}","isRoot":true,"Tpe":"="}'>
                                       <svg style="width: 4px; height: 4px; position: absolute; left: -2px; top: -2px;" viewBox="0 0 100 100">
                                           <circle cx="50" cy="50" r="50" strokeWidth="0" fill="black" opacity="0.5" />
                                       </svg>
                                    </TableMarkersLayer>
                                <TableMarkersLayer clusterMarkers="false" table="sites" query='{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{site_id}}","isRoot":true,"Tpe":"="}' />
                            </Map>
                           </div>
                        </div>
                    </Typography>
                </CardContent>
            </Card>
            <Card>
                <CardContent>
                    <Typography type="headline">
                        Proportion of antimalarial drug resistant parasites
                    </Typography>
                    <Typography type="subheading" color="secondary">

                    </Typography>

                    <Typography component="div" className="paragraph">
                    This plot shows the predicted number of resistant parasites for <strong><QueryResult table="pf_drugs"/></strong> major antimalarial drugs in {{name}}.
                    </Typography>

                    <Typography component="div" className="paragraph">
                    The count of parasites shown on the right is a subset of all parasites from {{name}} and includes only those where a confident prediction of resistance can be made. This number is different across drugs because we have less confidence to predict resistance in parasites where genotyping quality is low. Genotyping data quality varies across the genomes of individual parasites.
                    </Typography>


                    <Typography component="div">

                        <div style="padding-top: 20px">
                          <ProportionBarChartWrap
                            numberOfTickLabels="5"
                          >
                            {{#query 'drug_id' 'name' table='pf_drugs'}}
                              <ProportionBarChartRow
                                rowTable="pf_drugs"
                                rowPrimKeyValue="{{drug_id}}"
                                rowLabel="{{name}}"
                                proportionTable="pf_samples"
                                proportionTableColourColumn="{{drug_id}}resistant"
                                proportionTableColourColumnNumeratorValue="resistant"
                                numeratorBarColour="#69B3E4"
                                numeratorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{../site_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{drug_id}}resistant","CompValue":"resistant","Tpe":"="}],"Tpe":"AND"}'
                                denominatorQuery='{"whcClass":"compound","isCompound":true,"isRoot":true,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{../site_id}}","Tpe":"="},{"whcClass":"comparefixed","isCompound":false,"ColName":"{{drug_id}}resistant","CompValue":"missing","Tpe":"<>"}],"Tpe":"AND"}'
                                remainderTextColour="inherit"
                                onClickBehaviour="DocLink"
                                docLinkHref="drug_region.html"  drug_id="{{drug_id}}" region_id="{{../pf_regions.region_id}}"
                              />
                            {{/query}}
                          </ProportionBarChartWrap>
                        </div>

                    </Typography>

                    <Typography type="subheading" color="secondary">
                      Warning
                    </Typography>

                    <Typography component="div" className="paragraph">
                      The antimalarial drug resistance proportions presented here are <em>predictions</em> based on our analyses of drug resistance genetic markers. We do not measure resistance directly. Actual levels of resistance are likely to differ from these predictions. For more information on how we predict resistance see our technical documentation below.
                    </Typography>
                </CardContent>
            </Card>

            {{#query 'studies.study_number' 'studies.webTitle' 'studies.description' 'study_id' table='pf_samples' distinct='true' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{site_id}}","isRoot":true,"Tpe":"="}'}}
                    <Card>
                        <CardContent>
                            <Typography type="headline">
                                <strong>{{studies.study_number}}</strong>:{{{studies.webTitle}}}
                            </Typography>
                            <Typography type="subheading" color="secondary">
                                <strong><QueryResult table="pf_samples" query='{"whcClass":"compound","isCompound":true,"isRoot":false,"Components":[{"whcClass":"comparefixed","isCompound":false,"ColName":"site_id","CompValue":"{{../site_id}}","isRoot":true,"Tpe":"="}, {"whcClass":"comparefixed","isCompound":false,"ColName":"study_id","CompValue":"{{study_id}}","isRoot":true,"Tpe":"="}],"Tpe":"AND"}' /></strong> <em>P. Falciparum</em> samples from {{../name}}
                            </Typography>
                            <Typography component="div">
                                {{{studies.description}}}
                            </Typography>
                            <Typography component="p">
                                Key people:
                            </Typography>
                            <Typography component="ul">
                              {{#query 'givenName' 'sn' 'mail' table='study_ldap_people' query='{"whcClass":"comparefixed","isCompound":false,"ColName":"study","CompValue":"{{study_id}}","isRoot":true,"Tpe":"="}'}}
                                <Typography component="li">
                                  {{{givenName}}} {{{sn}}}, {{{mail}}}
                                </Typography>
                              {{else}}
                                <Typography component="li">
                                  <em>None</em>
                                </Typography>
                              {{/query}}
                            </Typography>
                        </CardContent>
                    </Card>
            {{/query}}

        </CardStack>
    </PageTemplate>
